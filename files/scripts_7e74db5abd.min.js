$(document).ready(function () {
    $(".franchise-doings-slider").slick({
        mobileFirst:true,
        dots: true,
        centerMode: true,
        infinite: true,
        slidesToShow: 4,
        slidesToScroll: 1,
        speed: 200,
        variableWidth: true,
        prevArrow: '<i class="slick-prev fa" aria-hidden="true"></i>',
        nextArrow: '<i class="slick-next fa" aria-hidden="true"></i>',
        responsive: [
            {
                breakpoint: 1024,
                settings: {
                    dots: false,
                    centerMode: false,
                    slidesToShow: 4,
                    slidesToScroll: 1,
                }
            },
            {
                breakpoint: 480,
                settings: {
                    dots: true,
                    centerMode: true,
                    slidesToShow: 1,
                    slidesToScroll: 1
                }
            }
        ]
    });
    if (window.matchMedia("(max-width: 768px)").matches) {
        $(".slick-mob").slick({
            infinite: true,
            slidesToShow: 1,
            slidesToScroll: 1,
            speed: 200,
            prevArrow: '<i class="slick-prev fa" aria-hidden="true"></i>',
            nextArrow: '<i class="slick-next fa" aria-hidden="true"></i>'
        });
        $(".slick-mob-diff").slick({
            dots: true,
            centerMode: true,
            slidesToShow: 1,
            slidesToScroll: 1,
            speed: 200,
            prevArrow: '<i class="slick-prev fa" aria-hidden="true"></i>',
            nextArrow: '<i class="slick-next fa" aria-hidden="true"></i>'
        });
    }
    $(".section.section-header .select ").on("click", ".btn", function (event) {
        event.preventDefault();
        var id = '.section-bookit',
            top = $(id).offset().top;
        $('body,html').animate({scrollTop: top}, 1500);
    });
    $(".section").on("click", ".link-inline", function (event) {
        event.preventDefault();
        var id = '.section-bookit',
            top = $(id).offset().top;
        $('body,html').animate({scrollTop: top}, 1500);
    });
    $(document).on('submit', 'form', function (e) {
        e.preventDefault();
        form = $(this);

        $.ajax({
            url: 'ajax.php',
            data: form.serialize(),
            type: "post",
            dataType: "json",
            success: function (resp) {
                $(form).find('input', 'button').remove();
                if (resp.transaction_id) {
                    ga('require', 'ecommerce');
                    ga('ecommerce:addTransaction', {
                        'id': resp.transaction_id,
                        'affiliation': 'Franchises Orders',
                        'revenue': resp.franchise_invest,
                        'shipping': '0',
                        'tax': '0'
                    });
                    ga('ecommerce:addItem', {
                        'id': resp.transaction_id,
                        'name': resp.franchise_name,
                        'sku': resp.order_article,
                        'category': resp.order_id,
                        'price': resp.franchise_invest,
                        'quantity': '1'

                    });
                    ga('ecommerce:send');
                }
                $('.section.section-bookit h2').html('Спасибо! Ваша заявка успешно отправлена!');
                form.remove();
            }
        });
    });
});

(function () {
    let moreButton = document.querySelector(".section-videos .show-more a.btn");
    moreButton.addEventListener("click", function(e){
        e.preventDefault();
        let vids = document.querySelector('.section-videos #videos-hidden')
        let vidsMobile = document.querySelector('.section-videos #videos-hidden-mob');
        if ($(window).width() < 767) {
            vidsMobile.classList.toggle('hide-me');
        }
        vids.classList.toggle('hide-me');
        this.textContent = (this.textContent == 'Показать еще') ? 'Скрыть' : 'Показать еще'
    })

    let moreButtonSlider = document.querySelector(".section-slider .show-more a.btn");
    moreButtonSlider.addEventListener("click", function(e){
        e.preventDefault();
        let slider = document.querySelector('.section-slider .slider-hidden')
        slider.classList.toggle('hide-me');
        this.textContent = (this.textContent == 'Ещё') ? 'Скрыть' : 'Ещё'
    })
})();

var width = $('#services-map').width(), height = 600;

var projection = d3.geoAlbers()
    .rotate([-105, 0])
    .center([-10, 65])
    .parallels([52, 64])
    .scale(700)
    .translate([width / 2, height / 3])
    .precision(.1);

var path = d3.geoPath()
    .projection(projection);

var svgContainer = d3.select("#services-map")
    .append("svg")
    .attr("width", width)
    .attr("height", height)
    .attr('id', 'svg');
var regionsGroup = svgContainer.append("g");
var servicesGroup = svgContainer.append("g");
var popup = document.getElementById('popup');

var currentZoom = 1;

d3.json("/files/russia.json", function(russia) {

    var regions = topojson.feature(russia, russia.objects.name).features;
    var pedants = russia.services;

    regionsGroup.selectAll("path")
        .data(regions).enter()
        .append("path")
        .attr("d", path)
        .attr("class", "region")
        .each(function(d) {
            var p = d3.select(this);
            p.attr("data-name", d.properties.name);
            p.attr("data-region", d.properties.id);
        });

    var index = 1;

    servicesGroup.selectAll("path")
        .data(pedants).enter()
        .append("g")
        .attr("class", "service")
        .attr("data-id", function(d) { return d.properties.region; })
        .attr("data-name",function(d) { return d.properties.name; })
        .attr("data-address",function(d) { return d.properties.address; })
        .attr("data-url",function(d) { return d.properties.url; })
        .attr("data-phone",function(d) { return d.properties.phone; })
        .attr("data-jobtime",function(d) { return d.properties.jobtime; })
        .attr("data-fasade",function(d) { return d.properties.image; })
        .each(function(g) {
            d3.select(this)
                .attr("data-index", index)
                .append('circle')
                .attr("cx", function(d) { return projection([d.geometry.coordinates[0],d.geometry.coordinates[1]])[0]; })
                .attr("cy", function(d) { return projection([d.geometry.coordinates[0],d.geometry.coordinates[1]])[1]; })
                .attr("r", "7");

            d3.select(this)
                .append("circle")
                .attr("r", "2")
                .attr("fill", "#000")
                .attr("class", 'black dot')
                .attr("cx", function(d) { return projection([d.geometry.coordinates[0],d.geometry.coordinates[1]])[0]; })
                .attr("cy", function(d) { return projection([d.geometry.coordinates[0],d.geometry.coordinates[1]])[1]; });

            $('.services-map .list-items').append(g.properties.name + ', ');
            index++;
        });

    $('#services-map .service').tooltip({
        placement: 'right',
        title: function() {
            return $(this).data('name');
        }
    });

    $('#services-map .service').popover({
        placement: 'top',
        html: true,
        title: function() {
            return 'Pedant.ru ' + $(this).data('name');
        },
        content: function() {
            var html = '';
            var job_lines = $(this).data('jobtime').split('|');
            var image = $(this).data('fasade');

            if(typeof image !== 'undefined')
                html += '<div class="image"><img src="/assets/fasads/' + $(this).data('fasade') + '"></div>';

            html += '<div class="address">' + $(this).data('address') + '</div>';
            html += '<div class="phone">' + $(this).data('phone') + '</div>';
            return html;
        }
    });

    $('#services-map .service').on('show.bs.popover', function () {
        $('#services-map .service').popover('hide');
        $(this).tooltip('hide');
    });

    $('body').on('click', function(event){
        var popover = $(event.target).closest('.popover');
        var button = $(event.target).closest('.service');
        var list = $(event.target).closest('.list');
        if(popover.length == 0 && button.length == 0 && list.length == 0)
            $('#services-map .service').popover('hide');
    });

    $('#services-map .service').hover(function() {
        $(this).tooltip('show');
        var id = $(this).data('id');
        $('#services-map .region').filter(function() {
            return $(this).data('region') == id;
        }).addClass('highlight');
    }, function() {
        $('#services-map .region').removeClass('highlight');
    });


    var panZoom = svgPanZoom('#svg', {
        zoomEnabled: false,
        zoomScaleSensitivity: 0.5,
        controlIconsEnabled: false,
        dblClickZoomEnabled: false,
        center: true,
        fit: true,
        minZoom: 0.1,
        beforePan: function() {
            $('#services-map .service').popover('hide');
        }
    });

    var media = window.matchMedia("(max-width: 1023px)");

    if(media.matches)
    {
        panZoom.disablePan();
        $('.services-map .controls').hide();
    }
    else
    {
        panZoom.enablePan();
        $('.services-map .controls').show();
    }

    $(window).on('resize', function() {

        panZoom.reset();
        panZoom.fit();

        if(media.matches)
        {
            panZoom.disablePan();
            $('.services-map .controls').hide();
        }
        else
        {
            panZoom.enablePan();
            $('.services-map .controls').show();
        }
    });


    $('.plus').click(function(){
        panZoom.zoomIn();
    });

    $('.minus').click(function(){
        panZoom.zoomOut();
    });

    $('ul.list li').hover(function(){
        var id = $(this).data('index')
        $('#services-map .service').filter(function(){
            return $(this).data('index') == id;
        }).addClass('scale');
    }, function(){
        $('#services-map .service').removeClass('scale');
    });

    $('ul.list li').click(function(e) {
        e.preventDefault();

        if(media.matches) return;

        $('html, body').animate({scrollTop:$('#services-map').offset().top}, 500);

        var id = $(this).data('index');
        var service = $('#services-map .service').filter(function(){
            return $(this).data('index') == id;
        }).popover('show');
    });
});
